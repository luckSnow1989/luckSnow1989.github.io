---
sort: 1
---
# 负载均衡

## 1.负载均衡

### 1.1.什么是负载均衡

负载均衡，（Load Balance），其含义就是指将负载（工作任务）进行平衡、分摊到多个操作单元上进行运行，例如FTP服务器、Web服务器、企业核心应用服务器和其它主要任务服务器等，从而协同完成工作任务。

负载均衡构建在原有网络结构之上，它提供了一种透明且廉价有效的方法扩展服务器和网络设备的带宽、加强网络数据处理能力、增加吞吐量、提高网络的可用性和灵活性。

### 1.2.类型

- 按照实现方式分为： 软/硬负载。
    硬负载的代表就是F5设备，主要用于IP分发

- 按照作用于七层网络模型的，分为： 二层、三层、四层、七层等

- 负载实现位置的不同，分为：服务端负载、客户端负载

### 1.3.负载均衡算法
[代码案例](https://gitee.com/luckSnow/knowledge/tree/master/learn_code/src/main/java/com/zx/_09_%E6%9E%B6%E6%9E%84/load_balance)

- 轮询：顾名思义
- 随机：顾名思义  
- hash：跟请求的某个指标进行hash运算，使得同类型请求都命中到同一个服务上
- 加权：顾名思义。按照比重实现。实现的方案有很多
- 平滑加权轮询：加权的升级版，使得请求安装固定的规律进行负载均衡
- 最小连接数：请求发送到处理请求数最小的服务上。

## 2.负载均衡技术

- Nginx
    - 优点：开源软件，简单易部署；功能强大，七层负载基本可以满足所有需求。
    - 缺点：仅支持http，https，Email协议；对后端服务器的检测，仅通过IP+端口来检查，不可以通过URL来检查；不支持会话session保持的一致行，但可以通过IP+HASH来解决。

- LVS
    - 优点：工作在4层，仅做分发作用，没有流量产生，因此。负载性能最强，对内存和cpu消耗率更低；
    - 缺点：不支持正则表达式，不支持动静分离。

- haproxy
    - 优点：支持session会话保持一致，四层和七层都支持；支持通过URL来检测后端服务器的状态。
    - 缺点：在七层转发支持上，不如nginx强大。所有一般用来进行四层负载

- F5
    - 硬件级别的负载，主要用于IP分发，算是四层负载，功能相对单一，但是性能强劲。功能与LVS相似

- DNS
    - 对外公网IP地址的分发，算是四层负载。

- 客户端负载
    - Ribbon
    - LoadBalancer
    
本质上几乎所有的分布式技术，都会使用到拒载均衡，比如
- Rpc调用，一般都使用的客户端负载均衡算法
- 分布式定时任务，服务端负载均衡，找到唯一可以执行任务的服务
- MQ，发送/消费消息，确保服务器资源不浪费，确保消费能力跟得上生产


## 3.DNS负载

DNS如何实现全局负载均衡？ [https://www.zhihu.com/question/29787004](https://www.zhihu.com/question/29787004)

DNS域名解析： [https://blog.csdn.net/cywosp/article/details/38017027](https://blog.csdn.net/cywosp/article/details/38017027)

这里简单介绍。

1. 全局的运营商+区域层面的负载均衡，主要功能是就近原则的调度

2. 机房或集群内部的负载均衡，主要实现流量均摊、合理利用资源等

第二种可以实现简单的轮询、连接数均衡，可以做成复杂的使用服务能力评估的平衡。


## 4.四层负载和七层负载

### 4.1.含义

![image](img/负载均衡/media/image1.jpeg)

在七层网络模型中

- 【★】作用于七层（应用层）的就是七层负载均衡，基于http请求，根据URL、请求参数、请求头等信息实现。
- 【★】作用于四层（传输层）的就是四层负载均衡，就是基于IP+端口实现，相比于三层负载，多使用了一个端口进行负载。
- 作用于三层（网络层）的就是三层负载均衡，基于ip实现，通过虚拟IP接受请求，再将请求转发到真实的IP上
- 作用于二层（数据链路层）的就是二层负载均衡，基于Mac地址，通过虚机Mac接受请求，再将请求转发到真实的Mac上

### 4.2.四层负载均衡

就是基于IP+端口的负载均衡：在三层负载均衡的基础上，通过发布三层的IP地址（VIP），然后加上四层的端口号，来决定哪些流量需要做负载均衡，
对需要处理的流量进行NAT处理，转发至后台服务器，并记录下这个TCP或UDP的流量时由哪台服务器处理的，后续这个连接的所有流量都会同样转发到同一台服务器处理。

对应的负载均衡器称为四层交换机（L4 Switch），主要分析IP层及TCP/UDP层，实现四层负载均衡。此种负载均衡无法处理应用协议（如HTTP/FTP/MySQL等等）

实现四层负载均衡的软件有：
- F5：硬件负载均衡器：功能强大，但成本高
- LVS：重量级四层负载软件
- nginx：轻量级四层负载软件，带缓存功能，正则表达式较灵活
- haproxy：模拟四层转发，较灵活。

### 4.3.七层负载均衡
就是基于虚拟的URL或主机IP的负载均衡：在四层负载均衡的基础上（没有四层是绝对不可能有七层的）。

再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据VIP加80端口辨别是否需要处理的流量，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。
举个例子，如果你的Web服务器分两组：一组是中午的，一组是英文的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应语言的服务器组进行负载均衡处理。

对应的负载均衡称为七层交换机（L7 Switch），除了支持四层负载均衡外，还要分析应用层的信息，如HTTP协议URI或Cookie信息，实现七层负载均衡。此负载均衡器能理解应用协议。

实现七层负载均衡的软件有：
- haproxy：天生负载均衡技能，全面支持七层代理，会话保持，标记，路径转移。
- nginx：只在http协议还mail协议上功能比较好，性能与haproxy差不多。
- apache：功能较差
- MySQL proxy：功能尚可

### 4.4.区别

所谓的负载均衡，就是根据请求的信息不同，来决定怎么样转发流量

1.  七层是在四层的基础上，进一步的去进行负载
2.  七层在意的是应用层的特征，比如解析http协议、URL、cookie等，而四层分析IP层和TCP/UDP层
3.  技术实现不同： 四层常见软件是haproxy，LVS，七层常见软件是nginx
4.  性能不同，四层>七层
5.  扩展性和灵活度不同，四层<七层

四层与七层最大的区别，
- 四层架构简单，只处理网络层的信息，性能和吞吐量远高于七层。
- 七层功能丰富，控制更加灵活，使得网络转发更加智能，也是普通开发人员能够自己维护的。


## 5.SLB 服务器负载均衡

SLB（服务器负载均衡）：在多个提供相同服务的服务器的情况下，负载均衡设备存在虚拟服务地址，当大量客户端从外部访问虚拟服务IP地址时，
负载均衡设备将这些报文请求根据负载均衡算法，将流量均衡的分配给后台服务器以平衡各个服务器的负载压力，
避免在还有服务器压力较小情况下其他服务达到性能临界点出现运行缓慢甚至宕机情况，从而提高服务效率和质量。

因此对客户端而言，RS（real server 实际服务器）的IP地址即是负载均衡设备VIP（虚拟服务地址IP）地址，真正的RS服务器IP地址对于客户端是不可见的。

负载均衡和反向代理的真实区别：https://mp.weixin.qq.com/s/hx9rAxziY0zk4Hv7lrVFug
